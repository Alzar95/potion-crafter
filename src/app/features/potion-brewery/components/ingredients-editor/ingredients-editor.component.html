<div class="ingredients-editor">
  <form [formGroup]="ingredientsForm"
        [class]="isMobile() ? 'flex mb-3 flex-col gap-3' : 'flex mb-3'" (ngSubmit)="addIngredient()">
    <p-floatlabel class="w-3/4" [class.w-full]="isMobile()" variant="on">
      <p-select [class.w-full]="isMobile()" [options]="ingredientsSignal()" formControlName="ingredientsControl"
                optionLabel="name"
                optionValue="id"
                appendTo="body"
                inputId="name" styleClass="w-3/4"/>
      <label>Ингредиент</label>
    </p-floatlabel>
    <p-floatlabel class="w-1/2" [class.w-full]="isMobile()" variant="on">
      <input pInputText type="number" formControlName="count"
             autocomplete="off" class="w-full"/>
      <label>Количество</label>
    </p-floatlabel>
    <div class="w-[35%] flex justify-content-center align-items-center" [class.w-full]="isMobile()">
      <span
        class="w-full flex justify-center items-center text-[18px]">Цена за ед: {{ currentPricePerUnit() | currency }}</span>
    </div>
    <p-button [label]="isMobile() ? 'Добавить ингредиент' : '+'" [disabled]="ingredientsForm.invalid" type="submit"
              fluid/>
  </form>

  @if (selectedIngredients.length > 0) {
    @if (!isMobile()) {
      <div class="card">
        <p-table [value]="selectedIngredients" [tableStyle]="{ 'min-width': '50rem' }">
          <ng-template #header>
            <tr>
              <th>Ингредиент</th>
              <th>Количество</th>
              <th>Цена за ед.</th>
              <th>Сумма</th>
              <th>Действия</th>
            </tr>
          </ng-template>
          <ng-template #body let-item let-index="rowIndex">
            <tr>
              <td>{{ item.ingredient?.name }}</td>
              <td>{{ item.count }}</td>
              <td>{{ item.ingredient?.pricePerUnit | currency }}</td>
              <td>{{ item.totalPrice | currency }}</td>
              <td>
                <p-button severity="danger" (click)="removeIngredient(index)">
                  Удалить
                </p-button>
              </td>
            </tr>
          </ng-template>
          <ng-template #footer>
            <tr class="font-bold">
              <td colspan="3"><strong>Итого:</strong></td>
              <td colspan="2">
                <strong>{{ getTotalPrice() | currency }}</strong>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    } @else {
      <p-dataview #dv [value]="selectedIngredients" layout="list">
        <ng-template #list let-selectedIngredients let-index="rowIndex">
          <div class="grid grid-cols-1 gap-4">
            @for (selectedIngredient of selectedIngredients; track selectedIngredient.ingredient?.name) {
              <div class="card border-round-lg shadow-sm p-4 bg-surface">
                <div class="flex-column gap-3">
                  <div class="flex-column gap-2 text-sm">
                    <div class="flex mb-2">
                      <span class="w-32 text-gray-500">Ингредиент:</span>
                      <span class="font-medium">{{ selectedIngredient.ingredient?.name }}</span>
                    </div>
                    <div class="flex mb-2">
                      <span class="w-32 text-gray-500">Количество:</span>
                      <span>{{ selectedIngredient.count }}</span>
                    </div>
                    <div class="flex mb-2">
                      <span class="w-32 text-gray-500">Цена за ед:</span>
                      <span>{{ selectedIngredient.ingredient?.pricePerUnit | currency }}</span>
                    </div>
                    <div class="flex mb-2">
                      <span class="w-32 text-gray-500">Сумма:</span>
                      <span>{{ selectedIngredient.totalPrice | currency }}</span>
                    </div>
                    <div class="flex">
                      <span class="w-32 text-gray-500">Действия:</span>
                      <p-button
                        icon="pi pi-trash"
                        severity="danger"
                        size="small"
                        [pTooltip]="'Удалить'"
                        (click)="removeIngredient(index)"/>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </ng-template>
      </p-dataview>
    }
  }
</div>
